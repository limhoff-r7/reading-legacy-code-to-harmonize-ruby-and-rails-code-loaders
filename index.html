<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Reading Legacy Code to Harmonize Ruby and Rails Code Loaders</title>

    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Hakim El Hattab">

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div class="theme-font-montserrat theme-color-white-blue" style="width: 100%; height: 100%;">
    <div class="reveal">
        <div class="slides">
            <section>
                <h1>Reading Legacy Code to Harmonize Ruby and Rails Code Loaders</h1>
                <p>Luke Imhoff</p>
                <table>
                    <tbody>
                    <tr>
                        <th>
                            <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" width="14px" height="10px" viewBox="0 0 14 10" enable-background="new 0 0 14 10" xml:space="preserve">
                                            <g>
                                                <path d="M7,7L5.268,5.484L0.316,9.729C0.496,9.896,0.739,10,1.007,10h11.986c0.267,0,0.509-0.104,0.688-0.271L8.732,5.484L7,7z"></path>
                                                <path d="M13.684,0.271C13.504,0.103,13.262,0,12.993,0H1.007C0.74,0,0.498,0.104,0.318,0.273L7,6L13.684,0.271z"></path>
                                                <polygon points="0,0.878 0,9.186 4.833,5.079  "></polygon>
                                                <polygon points="9.167,5.079 14,9.186 14,0.875  "></polygon>
                                            </g>
                                        </svg>
                        </th>
                        <td>luke_imhoff@rapid7.com</td>
                        <td>Kronic.Deth@gmail.com</td>
                    </tr>
                    <tr>
                        <th>
                            <svg version="1.1" class="github-icon-svg"
                                            xmlns="http://www.w3.org/2000/svg"
                                            xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path>
                                        </svg>
                        </th>
                        <td>
                            <a href="https://github.com/limhoff-r7" target="_blank">@limhoff-r7</a>
                        </td>
                        <td>
                            <a href="https://github.com/KronicDeth" target="_blank">@KronicDeth</a>
                        </td>
                    </tr>
                    <tr>
                        <th>
                            <svg version="1.1" class="twitter-icon-svg"
                                            xmlns="http://www.w3.org/2000/svg"
                                            xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                                            <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path>
                                        </svg>
                        </th>
                        <td></td>
                        <td>
                            <a href="https://twitter.com/KronicDeth" target="_blank">@KronicDeth</a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </section>
            <section>
                <h1>Background</h1>
                <h2>Code-Loading</h2>
            </section>
            <section class="stack">
                <section>
                    <h2>Code-Loading in Ruby</h2>
                    <ul>
                        <li>
                            <code>load</code>
                        </li>
                        <li>
                            <code>require</code>
                        </li>
                        <li>
                            <code>autoload</code>
                        </li>
                    </ul>
                </section>
                <section>
                    <h2>
                        <code>load</code>,
                        <code>require</code>,
                        <code>autoload</code>
                    </h2>

                    <ul>
                        <li>Search
                            <code>$LOAD_PATH</code>
                        </li>
                    </ul>
                </section>
                <section>
                    <h2>
                        <code>load</code>
                    </h2>

                    <ul>
                        <li>File extension must be given</li>
                        <li>Will reload already loaded files</li>
                        <li>Reads file immediately</li>
                    </ul>
                </section>
                <section>
                    <h2>require</h2>
                    <ul>
                        <li>File extensions are automatic</li>
                        <li>Will not reload already loaded files</li>
                        <li>Read file immediately</li>
                    </ul>
                </section>
                <section>

                    <h2>autoload</h2>

                    <ul>
                        <li>File extensions are automatic</li>
                        <li>Will not reload already loaded files</li>
                        <li>Read file when constant accessed</li>
                    </ul>
                    <pre><code data-trim>
# lib/parent.rb
module Parent
  autoload :Child, 'parent/child'
end

# lib/parent/child.rb
  module Parent::Child
end
                    </code></pre>
                </section>
            </section>
            <section class="stack">
                <section>
                    <h2>Code-Loading in Rails</h2>
                    <ul>
                        <li>
                            <code>ActiveSupport::Autoload</code>
                        </li>
                        <li>
                            <code>ActiveSupport::Dependencies.autoload_paths</code>
                        </li>
                    </ul>
                </section>
                <section>
                    <h2>ActiveSupport::Autoload</h2>

                    <ul>
                        <li>File

                            <strong>paths</strong>are automatic

                        </li>
                        <li>Will not reload already loaded files</li>
                        <li>Read file when constant accessed</li>
                    </ul>
                    <pre><code>
# lib/parent.rb
module Parent
  extend ActiveSupport::Autoload

  autoload :Child
end
                    </code></pre>
                </section>
                <section>
                    <h2>
                        <span style="font-size:32px">ActiveSupport::Dependencies.autoload_paths</span>
                    </h2>
                    <ul>
                        <li>Specify root directories</li>
                        <li>File paths and <strong>constants</strong> are automatic </li>
                        <li>Powers
                            <code>config.autoload_paths</code>
                        </li>
                    </ul>
                </section>
            </section>
            <section>
                <h2>
                    <span style="font-size:32px">Code-Loading in Ruby and Rails</span>
                </h2>
                <table width="100%">
                    <thead>
                    <tr>
                        <th>Loader</th>
                        <th>Extension Required</th>
                        <th>Loads Only Once</th>
                        <th>Thread-safe</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><code>Kernel.load</code></td>
                        <td>Yes</td>
                        <td>No</td>
                        <td>No</td>
                    </tr>
                    <tr>
                        <td><code>Kernel.require</code></td>
                        <td>No</td>
                        <td>Yes</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td><code>Kernel.autoload</code></td>
                        <td>No</td>
                        <td>Yes</td>
                        <td>No (1.9) / Yes (2.0+)</td>
                    </tr>
                    <tr>
                        <td><code>ActiveSupport::Autoload#autoload</code></td>
                        <td>No</td>
                        <td>Yes</td>
                        <td>No (1.9) / Yes (2.0+)</td>
                    </tr>
                    <tr>
                        <td><code>ActiveSupport::Dependencies#autoload_paths</code></td>
                        <td>No</td>
                        <td>Either</td>
                        <td>No</td>
                    </tr>
                    </tbody>
                </table>
            </section>
            <section>
                <h2>Setting</h2>
                <ul>
                    <li>metasploit-framework: 9 years old (5&nbsp;ruby / 4 perl)</li>
                    <li>Metasploit Pro: 2 years old</li>
                    <li>Rails 3.2.2: 5 months old</li>
                </ul>
            </section>
            <section>
                <div style="float: left">
                    <h2>UI</h2>
                    <p>A standard Rails application</p>
                </div>
                <div style="float: right">
                    <h2>prosvc</h2>
                    <p>daemon UI uses to run metasploit-framework</p>
                </div>
            </section>
            <section class="stack">
                <section>
                    <h1>prosvc</h1>
                    <h2>it had a few problems</h2>
                </section>
                <section>
                    <h2>Too long</h2>
                    <img src="images/prosvc.png">
                </section>
                <section>
                    <h2>Duplicating Bundler</h2>
                    <img src="images/prosvc-duplicating-bundler.png">
                </section>
                <section>
                    <h2>Platform-specifics</h2>
                    <img src="images/prosvc-platform-specifics.png">
                </section>
                <section>
                    <h2>
                        Emulating <code>config.autoload_paths</code>
                    </h2>
                    <img src="images/prosvc-emulating-config-autoload-paths.png">
                </section>
            </section>
            <section>
                <h2>Goals</h2>
                <ul>
                    <li>Eliminate
                        <code>relative_requires</code> in <code>prosvc</code>
                    </li>
                    <li>Eliminate explicit
                        <code>require</code>s in
                        <code>prosvc</code>
                    </li>
                    <li>Share
                        <code>autoload_paths</code> between UI and
                        <code>prosvc</code>
                    </li>
                </ul>
            </section>
            <section>
                <h2>Outline</h2>
                <ul>
                    <li>Add <code>config.autoload_paths</code> outside Rails</li>
                    <li>Learn about a new type of code-loading</li>
                    <li>Learn about anonymous modules</li>
                    <li>Read <code>ActiveSupport::Dependencies</code> internals</li>
                    <li>Learn about lexical scope</li>
                    <li>Learn about constant resolution</li>
                </ul>
            </section>
            <section class="stack">
                <section>
                    <h1>
                        <code>config.autoload_paths</code> outside Rails
                    </h1>
                </section>
                <section>
                    <h2>
                        Barriers to
                        <code>config.autoload_paths</code> in
                        <code>prosvc</code>
                    </h2>
                    <ul>
                        <li>Don't know how to use outside of Rails</li>
                        <li>Don't know how
                            <code>config.autoload_paths</code> works
                        </li>
                        <li>Don't know which gem handles
                            <code>config.autoload_paths</code>
                        </li>
                    </ul>
                </section>
                <section>
                    <h2>RTF
                        <s>M</s>G
                    </h2>
                    <p>
                        <code>config.autoload_paths</code> is mentioned in the Configuring guide

                    </p>
                    <img src="images/configuring-set_autoload_paths.png">
                </section>
                <section>
                    <h2>
                        Where is
                        <code>set_autoload_paths</code>?

                    </h2>

                    <ol>
                        <li>Search rubygem.org for rails</li>
                        <li>Show all versions</li>
                        <li>Find 3.2.2</li>
                    </ol>

                    <table>
                        <thead>
                        <tr>
                            <th>Gem</th>
                            <th>Purpose</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>actionmailer</td>
                            <td>sending mail</td>
                        </tr>
                        <tr>
                            <td>activerecord</td>
                            <td>database records</td>
                        </tr>
                        <tr>
                            <td>activeresource</td>
                            <td>non-database records</td>
                        </tr>
                        <tr>
                            <td>bundler</td>
                            <td>dependency management</td>
                        </tr>
                        <tr>
                            <td>actionpack</td>
                            <td>?</td>
                        </tr>
                        <tr>
                            <td>activesupport</td>
                            <td>?</td>
                        </tr>
                        <tr>
                            <td>railties</td>
                            <td>?</td>
                        </tr>
                        </tbody>
                    </table>
                </section>
                <section>
                    <h2>
                        Check actionpack, activesupport, and railties
                    </h2>
                    <ol>
                        <li>No Source Links</li>
                        <li>Assume rails Source Links</li>
                    </ol>
                    <img src="images/rails-3.2.2-tree.png">
                </section>
                <section>
                    <h2>Searching Legacy Code</h2>
                    <ol>
                        <li>Try Github search</li>
                        <li>Realize Github search only works on master&nbsp;</li>
                        <li>Clone rails</li>
                        <li>Checkout 3.2.2</li>
                        <li>Search locally</li>
                    </ol>
                    <pre><code>
cd ~/git
mkdir rails
cd rails
git clone git@github.com:rails/rails.git
cd rails
git checkout v3.2.2
ack set_autoload_paths
                    </code></pre>
                </section>
                <section>
                    <h2>ack</h2>
                    <ul>
                        <li>Like grep, but smarter</li>
                        <li>Automatically searches current directory tree</li>
                        <li>Ignores .git</li>
                        <li>Automatically prints matching lines with line numbers and highlights</li>
                    </ul>
                </section>
                <section>
                    <h2>
                        <code>ack set_autoload_path</code>
                    </h2>
                    <ol>
                        <li>Configuring guide source</li>
                        <li>DSL call to define initializer</li>
                    </ol>
                    <br/>
                    <img src="images/ack-set_autoload_paths.png">
                </section>
                <section>
                    <h2>
                        <code>railties/lib/rails/engine.rb:536</code>
                    </h2>
                    <img src="images/railties-lib-rails-engine-line-536.png">
                </section>
                <section>
                    <h2>
                        <code>_all_autoload_paths</code>
                    </h2>
                    <img src="images/all_autoload_paths.png">
                    <br/>
                    <ul>
                        <li>
                            <code>config.autoload_paths</code>
                        </li>
                        <li>
                            <code>config.eager_load_paths</code>
                        </li>
                        <li>
                            <code>config.autoload_once_paths</code>
                        </li>
                </section>
            </section>
            <section>
                <h2>Emulate
                    <code>set_autoload_paths</code>
                </h2>
                <ul>
                    <li>
                        <code>config.autoload_paths</code>
                    </li>
                    <li>
                        <s>
                            <code>config.eager_load_paths</code>
                        </s>
                    </li>
                    <li>
                        <s>
                            <code>config.autoload_once_paths</code>
                        </s>
                    </li>
                </ul>
                <pre><code>ActiveSupport::Dependencies.autoload_paths.unshift(config.autoload_paths)</code></pre>
            </section>
            <section class="stack">
                <section>
                    <h1>
                        Calling initializers without
                        <code>Rails::Engine</code>
                    </h1>
                    <ul>
                        <li>Initializers are just methods</li>
                        <li>Need to emulate calling convention too</li>
                    </ul>
                </section>
                <section>
                    <h2>Back to the Guide</h2>
                    <img src="images/configuring-rails-railtie-initializer.png">
                    <br/>
                    <ul>
                        <li>Check earlier in file for other initializer</li>
                        <li>Check for other initializers with
                            <code>:before =&gt; :set_autoload_paths</code>
                        </li>
                    </ul>
                </section>
                <section>
                    <h2>
                        <code>set_load_path</code>
                    </h2>
                    <img src="images/set_load_paths.png">
                </section>
                <section>
                    <h2>
                        <code>_all_load_paths</code>
                    </h2>
                    <img src="images/all_load_paths.png">
                    <br/>
                    <ul>
                        <li>
                            <code>_all_load_paths</code> →
                            <code>_all_autoload_paths</code>
                        </li>
                        <li>
                            <code>set_autoload_paths</code> →
                            <code>set_load_paths</code>
                        </li>
                    </ul>
                </section>
                <section>
                    <h2>prosvc load paths</h2>
                    <img src="images/3370204851ac2d93ba2b3816b3762350799c21df-engine-prosvc-diff.png">
                </section>
            </section>
            <section>
                <h1>Separating initializers and configuration</h1>
            </section>
            <section class="stack">
                <section>
                    <table>
                        <tbody>
                        <tr>
                            <th>System</th>
                            <th>Initializers</th>
                            <th>Configuration</th>
                        </tr>
                        <tr>
                            <td>Rails</td>
                            <td>
                                <code>Rails::Engine</code>
                            </td>
                            <td>
                                <code>Rails::Engine::Configuration</code>
                            </td>
                        </tr>
                        <tr>
                            <td>prosvc</td>
                            <td>
                                <code>Metasploit::Configured</code>
                            </td>
                            <td>
                                <code>Metasploit::Configuration</code>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </section>
                <section>
                  <pre class="stretch"><code>
require 'active_support/concern'

# TODO this should be a Rails::Engine if engine is ever moved under ui
module Metasploit::Configured
  extend ActiveSupport::Concern

  module ClassMethods
    def configuration
      @configuration ||= self::Configuration.new
    end

    def initialize!
      configuration.initializers.each do |initializer|
        send(initializer)
      end
    end

    def eager_load!
      configuration.dependencies.each(&amp;:eager_load!)

      # Adapted from Rails::Engine#eager_load!
      configuration.eager_load_paths.each do |load_path|
        # strip the load_path itself from the name because the load_path is already add to $LOAD_PATH by
        # {#set_load_path}.
        # strip extension as it's not normally passed to require.
        require_path_regex = /\A#{Regexp.escape(load_path)}\/(.*)\.rb\Z/
        glob = "#{load_path}/**/*.rb"

        Dir.glob(glob) do |path|
          require_path = path.sub(require_path_regex, '\1')

          require_dependency require_path
        end
      end
    end

    def root
      configuration.root
    end

    def set_load_path
      configuration.dependencies.each(&amp;:set_load_path)

      # reverse because unshift is pushing onto the front
      configuration.all_autoload_paths.reverse_each do |path|
        if File.directory?(path)
          $LOAD_PATH.unshift(path)
        end

        # uniq at end in case all_autoload_paths include paths already in $LOAD_PATH
        $LOAD_PATH.uniq!
      end
    end

    def set_autoload_paths
      configuration.dependencies.each(&amp;:set_autoload_paths)

      ActiveSupport::Dependencies.autoload_paths.unshift(*configuration.all_autoload_paths)

      # Freeze so future modifications error out instead of being silently ignored
      configuration.autoload_paths.freeze
      configuration.eager_load_paths.freeze
    end
  end
end
                  </code></pre>
                </section>
                <section>
                    <pre><code>
require 'active_support/concern'

module Metasploit::Configured
  module ClassMethods
    def configuration
      @configuration ||= self::Configuration.new
    end
  end
end
                    </code></pre>
                    <table>
                        <tbody>
                        <tr>
                            <th>
                                <code>self::Configuration</code>
                            </th>
                            <th>
                                <code>Configuration</code>
                            </th>
                        </tr>
                        <tr>
                            <td>Scoped to base class</td>
                            <td>Scoped to <code>Metasploit::Configured::ClassMethods<code></td>
                        </tr>
                        </tbody>
                    </table>
                </section>
                <section>
                    <pre><code>
module Metasploit::Configured
  module ClassMethods
    def initialize!
      configuration.initializers.each do |initializer|
        send(initializer)
      end
    end
  end
end
                    </code></pre>
                    <ul>
                        <li>initializers are assumed to be in order</li>
                        <li>initializers are assumed to be methods</li>
                        <li>
                            <code>initialize!</code> to match Rails convention
                        </li>
                    </ul>
                    <pre><code>
# Load the rails application
require File.expand_path('../application', __FILE__)

# Initialize the rails application
Pro::Application.initialize!
                    </code></pre>
                </section>
                <section>
                    <pre class="stretch"><code>
module Metasploit::Configured
  module ClassMethods
    def eager_load!
      configuration.dependencies.each(&amp;:eager_load!)

      # Adapted from Rails::Engine#eager_load!
      configuration.eager_load_paths.each do |load_path|
        # strip the load_path itself from the name because the load_path is
        # already add to $LOAD_PATH by {#set_load_path}.
        # strip extension as it's not normally passed to require.
        require_path_regex = /\A#{Regexp.escape(load_path)}\/(.*)\.rb\Z/
        glob = "#{load_path}/**/*.rb"

        Dir.glob(glob) do |path|
          require_path = path.sub(require_path_regex, '\1')

          require_dependency require_path
        end
      end
    end
  end
end
                    </code></pre>
                </section>
                <section>
                    <pre><code>
module Metasploit::Configured
  module ClassMethods
    def root
      configuration.root
    end
  end
end
                    </code></pre>
                    <ul>
                        <li>Allow Metasploit::Pro.root</li>
                        <li>Emulate Rails.application.root</li>
                    </ul>
                </section>
                <section>
                    <pre style="float: left; width: 50%"><code>
module Metasploit::Configured
  module ClassMethods
    def set_load_path
      configuration.dependencies.each(&amp;:set_load_path)

      # reverse because unshift is pushing onto the front
      configuration.all_autoload_paths.reverse_each do |path|
        if File.directory?(path)
          $LOAD_PATH.unshift(path)
        end

        # uniq at end in case all_autoload_paths include paths
        # already in $LOAD_PATH
        $LOAD_PATH.uniq!
      end
    end
  end
end
                    </code></pre>
                    <pre style="float: right; width: 50%"><code>
module Rails
  class Engine &lt; Railtie
    def ordered_railties
      railties.all + [self]
    end

    def initializers
      initializers = []
      ordered_railties.each do |r|
        if r == self
          initializers += super
        else
          initializers += r.initializers
        end
      end
      initializers
    end
  end
end
                    </code></pre>
                    <ul>
                        <li>There are multiple initializers with same name&nbsp;(one per engine/application)
                        </li>
                        <li>Engine initializers are called before application initializers</li>
                    </ul>
                </section>
                <section>
                    <pre style="float: left; width: 50%"><code>
module Metasploit::Configured
  module ClassMethods
    def set_load_path
      configuration.dependencies.each(&amp;:set_load_path)

      # reverse because unshift is pushing onto the front
      configuration.all_autoload_paths.reverse_each do |path|
        if File.directory?(path)
          $LOAD_PATH.unshift(path)
        end

        # uniq at end in case all_autoload_paths include paths
        # already in $LOAD_PATH
        $LOAD_PATH.uniq!
      end
    end
  end
end
                    </code></pre>
                    <pre style="float: right; width: 50%"><code>
module Rails
  class Engine &lt; Railtie
    initializer :set_load_path, :before =&gt; :bootstrap_hook do
      _all_load_paths.reverse_each do |path|
        $LOAD_PATH.unshift(path) if
        File.directory?(path)
      end
      $LOAD_PATH.uniq!
    end
  end
end
                    </code></pre>
                    <ul>
                        <li>Engine (dependency) initializer calling is explicit</li>
                        <li>Rest is code style differences</li>
                    </ul>
                </section>
                <section>
                    <pre class="stretch"><code>
module Metasploit
  class Configuration
    def all_autoload_paths
      all_autoload_paths = autoload_paths + eager_load_paths
      unique_autoload_paths = all_autoload_paths.uniq

      unique_autoload_paths
    end

    def autoload_paths
      @autoload_paths ||= []
    end

    def dependencies
      @dependencies ||= []
    end

    def eager_load_paths
      @eager_load_paths ||= []
    end

    def initializers
      # XXX not sure I like that initializer methods that only exist in
      # Metasploit::Configured are used here.
      @initializers ||= [
        :set_load_path,
        :set_autoload_paths,
        :eager_load!
      ]
    end

    attr_reader :root
  end
end
                    </code></pre>
                </section>
                <section>
                    <pre><code>
module Metasploit
  class Configuration
    def initializers
      # XXX not sure I like that initializer methods that only exist in
      # Metasploit::Configured are used here.
      @initializers ||= [
        :set_load_path,
        :set_autoload_paths,
        :eager_load!
      ]
    end
  end
end
                    </code></pre>
                    <ul>
                        <li>No :before</li>
                        <li>No :after</li>
                        <li>Order is explicit</li>
                        <li>Simplified ordering code</li>
                    </ul>
                </section>
            </section>
            <section class="stack">
                <section>
                    <h1>Porting prosvc</h1>
                </section>
                <section>
                    <h2>prosvc requires</h2>
                    <pre class="stretch"><code>
#
# Load our own library path and the
standard Metasploit Framework path
#
$:.unshift(File.expand_path(File.join(File.dirname(__FILE__), 'lib')))
$:.unshift(File.expand_path(File.join(File.dirname(__FILE__), '..', 'msf3', 'lib')))

if ENV['RAILS_ENV'] == "development"
  $stdout.puts "[!] Starting Pro service in a development environment"

  #
  # Development mode explicitly enables bundler
  #

  ENV['BUNDLE_GEMFILE'] = File.expand_path(File.join(File.dirname(__FILE__), '..', 'ui', 'Gemfile'))
  ENV['BUNDLE_PATH'] = ENV['GEM_HOME']

  require "bundler/setup"
else

  #
  # Production mode configures the search path via framework's lib/msf/env/gemcache.rb
  #

  # Accept binary gems from the cache
  ENV['MSF_BUNDLE_BINARY_GEMS'] = "1"

  require 'msf/env/gemcache'

  #
  # Explicitly require the libraries we need
  #

  require 'eventmachine'
  require 'nokogiri'
  require 'msgpack'
  require 'pg'
end

# AuthLogic needed by Mdm::User
require 'authlogic'

# Load gem deps they share
require 'state_machine'
require 'liquid'
require 'acts_as_list'
require 'action_mailer'
require 'carrierwave'
require
'carrierwave/orm/activerecord'
require_relative
'../ui/config/initializers/carrierwave'

#
# Load specific patches for system
libraries
#
if arch == "win32"
  require "win32/registry"
  require "patches/win32_registry"
end

if arch == "linux32" or arch ==
  "linux64"
  # require 'openssl_nonblock'

  # Expand our maximum file limit as high as it will go
  while true
    begin; Process.setrlimit(Process::RLIMIT_NOFILE, 32768, 32768); break; rescue ::Exception; end
    begin; Process.setrlimit(Process::RLIMIT_NOFILE, 16384, 16384); break; rescue ::Exception; end
    begin; Process.setrlimit(Process::RLIMIT_NOFILE, 8192, 8192); break; rescue ::Exception; end
    begin; Process.setrlimit(Process::RLIMIT_NOFILE, 4096, 4096); break; rescue ::Exception; end
    begin; Process.setrlimit(Process::RLIMIT_NOFILE, 1024, 1024); break; rescue ::Exception; end
    break
  end
end

#
# Configure the process environment to work with java and other tools
#
pdel = (arch == "win32") ? ";" : ":"
bins = %W{ common/bin ruby/bin
nmap/bin postgresql/bin apache2/bin
java/bin jruby/bin }
pathparts = ENV['PATH'].split(pdel)
bins.each do |bpath|
  pathparts.unshift
  File.expand_path(File.join(File.dirname(__FILE__), "..", "..", "..", bpath))
end
ENV['PATH'] = pathparts.uniq.join(pdel)
ENV['JAVA_HOME'] = File.expand_path(File.join(File.dirname(__FILE__), "..", "..", "..", 'java'))
ENV['TERMINFO'] = File.expand_path(File.join(File.dirname(__FILE__), "..", "..", "..", 'common', 'share', 'terminfo'))
ENV['DISPLAY'] = nil

# Convert path delimiters for
Windows
if arch == "win32"
  ENV['PATH'] = ENV['PATH'].gsub("/", "\\")
  ENV['JAVA_HOME'] = ENV['JAVA_HOME'].gsub("/", "\\")
end

#
# Require our basic libraries and start loading
#
require 'metasploit_data_models'
include MetasploitDataModels
# Figure out the rails path
rails_app_path = File.expand_path(File.dirname(__FILE__)) + "/../ui/app"
# Bring all Mdm::* models into view
Dir.glob("#{rails_app_path}/models/mdm/*.rb").each do |mdm_model_path|
  require mdm_model_path
end

# ---- BEGIN - Load all things SocialEngineering from Rails ----
module LiquidTemplating; end
liquid_files = Dir.glob("#{rails_app_path}/../lib/liquid_templating/*.rb")
liquid_files.sort.each do |liquid_path|
  require liquid_path
end

# TODO: any better way to have both Rails and prosvc happy w/ talking to License?
require "#{rails_app_path}/models/license.rb"

# Declare the module manually - Rails does this from directory structure
module SocialEngineering; end
require "#{rails_app_path}/uploaders/social_engineering/campaign_file_uploader.rb"

manually_loaded_models = ["human_target", "email", "web_page_attack_config_interface"]
skippable_files = ["campaign_task"]
require "#{rails_app_path}/models/social_engineering/human_target.rb"
# avoid chicken-egg
require "#{rails_app_path}/models/social_engineering/web_page_attack_config_interface.rb"
# avoid chicken-egg

se_files = Dir.glob("#{rails_app_path}/models/social_engineering/*.rb")
se_files.sort.each do |se_model_path|
  file_name = File.basename(se_model_path).split('.').first
  next if skippable_files.include? file_name
  next if manually_loaded_models.include? file_name
  require se_model_path
end
# ---- END - Load all things SocialEngineering from Rails ----

require 'msf/ui'
require 'rex'

# Metasploit Core API
require 'msf/core/rpc/v10/service'

# Pro API
require 'pro/filters'
require 'pro/config'
require 'pro/rpc/v10/rpc_pro'

# Pro Mixins
require 'pro/mixins'

# Pro Hooks
require 'pro/hooks'

# Pro Client
require 'pro/client'

# Background Daemon
require 'pro/bgdaemon'

# NginX
require "pro/nginx"

#
# This is required to dynamically
load all MDM modules
# since we have namespace classes
which AR tries to log
#

require 'logger'
::FileUtils.mkdir_p(File.expand_path(File.join(File.dirname(__FILE__), "config", "logs")))
ActiveRecord::Base.logger = Logger.new( File.expand_path(File.join(File.dirname(__FILE__), "config", "logs", "db.log" )))


# Load individual namespaces and
models
require_relative "#{rails_app_path}/models/user_session.rb"
require_relative "#{rails_app_path}/models/task_chain.rb"
require_relative "#{rails_app_path}/models/scheduled_task.rb"
require_relative "#{rails_app_path}/models/campaign.rb"
require_relative "#{rails_app_path}/models/attachment.rb"
require_relative "#{rails_app_path}/models/email_template.rb"
require_relative "#{rails_app_path}/models/email_address.rb"
require_relative "#{rails_app_path}/models/web_template.rb"


# Load classes in lib root
ui_lib_path = File.expand_path(File.dirname(__FILE__)) + "/../ui/lib"
require "#{ui_lib_path}/sender.rb"
lib_files = Dir.glob("#{ui_lib_path}/*.rb")
lib_files.sort.each do |lib_class|
  require lib_class
end
                    </code></pre>
                </section>
            </section>
            <section class="stack">
                <section>
                    <h2>Roots</h2>
                    <ol>
                        <li>msf3 (metasploit&#8209;framework)</li>
                        <li>ui</li>
                        <li>engine</li>
                    </ol>
                </section>
                <section>
                    <pre class="stretch"><code>
module Metasploit::Framework
  class Configuration &lt; Metasploit::Configuration
    def initialize
      @root = Metasploit::Pro.root.join('msf3')

      lib_pathname = root.join('lib')
      lib_path = lib_pathname.to_s
      autoload_paths &lt;&lt; lib_path

      base_pathname = root.join('lib', 'base')
      base_path = base_pathname.to_s
      autoload_paths &lt;&lt; base_path
    end
  end
end
                    </code></pre>
                </section>
                <section>
                    <pre class="stretch"><code>
module Metasploit::Pro::Engine
  class Configuration &lt; Metasploit::Configuration
    def initialize
      @dependencies = [
        Metasploit::Framework,
        Metasploit::Pro::UI
      ]

      @root = Metasploit::Pro.root.join('engine')

      lib_pathname = root.join('lib')
      lib_path = lib_pathname.to_s
      autoload_paths &lt;&lt; lib_path
    end
  end
end
                    </code></pre>
                </section>
                <section>
                    <pre class="stretch"><code>
module Metasploit::Pro::UI
  class Configuration &lt; Metasploit::Configuration
    def initialize
      @root = Metasploit::Pro.root.join('ui')

      lib_pathname = root.join('lib')
      lib_path = lib_pathname.to_s
      autoload_paths &lt;&lt; lib_path

      # Some models reference the controllers,
      # so app/controllers needs to be added to autoload paths
      controllers_pathname = root.join('app', 'controllers')
      controllers_path = controllers_pathname.to_s
      autoload_paths &lt;&lt; controllers_path

      uploaders_pathname = root.join('app', 'uploaders')
      uploaders_path = uploaders_pathname.to_s
      autoload_paths &lt;&lt; uploaders_path

      models_pathname = root.join('app', 'models')
      models_path = models_pathname.to_s
      autoload_paths &lt;&lt; models_path
    end
  end
end
                    </code></pre>
                </section>
            </section>
            <section class="stack">
                <section>
                    <h1>Testing with Metasploit Module Loader</h1>
                </section>
                <section>
                    <h2>A Side Note on Narrative</h2>
                    <ul>
                        <li>I didn't know this use case when I wrote this originally</li>
                        <li>I was just restart prosvc over and over for a couple weeks</li>
                        <li>Egypt pointed out this use case in the PR</li>
                    </ul>
                </section>
                <section>
                    <h2>msfpro start-up</h2>
                    <ol>
                        <li>Loads all modules
                            <ol>
                                <li>Loads all autoload_paths</li>
                            </ol>
                        </li>
                        <li>Presents prompt</li>
                    </ol>
                </section>
                <section>
                    <h2>msfpro test</h2>
                    <ol>
                        <li>Loads all modules

                            <ol>
                                <li>Loads all autoload_paths</li>
                            </ol>
                        </li>
                        <li>Presents prompt</li>
                        <li>
                            <strong>Remove autoload_path class constant</strong>
                        </li>
                        <li>
                            <strong>Force reload of autoload_path class</strong>
                        </li>
                    </ol>
                </section>
            </section>
            <section class="stack">
                <section>
                    <img class="stretch" src="images/wrong-constant-name.png">
                </section>
                <section>
                    <h2>How did I break the code?</h2>
                    <ul>
                        <li>NameError</li>
                        <li>Wrong constant name</li>
                        <li>Gibberish constant name (#&lt;Module:0x10x916448&gt;)</li>
                    </ul>
                </section>
                <section>
                    <h2>How do I fix the code?</h2>
                    <ul>
                        <li>Use Call stack (backtrace)</li>
                        <li>Look at first line</li>
                    </ul>
                    <br/>
                    <img class="stretch" src="images/activesupport-3-2-2-lib-active-support-inflector-methods-line-229.png">
                </section>
                <section>
                    <h2>Where next?</h2>
                    <ul>
                        <li>constantize is pure, so follow arguments up stack</li>
                    </ul>
                </section>
                <section>
                    <img class="stretch" src="images/module-const-missing-const-missing.png">
                </section>
                <section>
                    <h2>What called const_missing?</h2>
                    <ul>
                        <li>Follow the backtrace</li>
                    </ul>
                </section>
                <section>
                    <img class="stretch" src="images/auxiliary-pro-social-engineering-web-phish-run.png">
                    <p><code>const_missing</code> is implicitly called by Ruby VM when accessing <code>SocialEngineering</code></p>
                </section>
                <section>
                    <img src="images/module-const-missing-const-missing.png" style="float: left; width: 50%">
                    <h1>Dataflow</h1>
                    <ol>
                        <li><code>name</code></li>
                        <li><code>name.presence</code></li>
                        <li><code>klass_name</code></li>
                        <li><code>klass_name.to_s</code></li>
                        <li><code>klass_name.to_s.scan</code></li>
                        <li><code>nesting</code></li>
                    </ol>
                </section>
                <section>
                    <h2>Origin of wrong name</h2>
                    <ol>
                        <li>Entire
                            <code>Module#name</code>
                        </li>
                        <li>Part of
                            <code>Module#name</code> containing
                            <code>::</code>
                        </li>
                    </ol>
                </section>
                <section>
                    <h2>To the debugger!</h2>
                    <ul>
                        <li>symlinks prevent ruby-debug-ide breakpoints from triggering</li>
                        <li>pry not built for production</li>
                        <li>debugger not built for production</li>
                    </ul>
                </section>
                <section>
                    <h1>print debugging</h1>
                    <img class="stretch" src="images/module-const-missing-const-missing-debugging.png">
                </section>
                <section>
                    <h2>Namespace Module is wrong</h2>
                    <img class="stretch" src="images/debugging-output.png">
                </section>
                <section>
                    <h2>Where is <code>Metasploit3?</code></h2>
                    <img class="stretch" src="images/auxiliary-pro-social-engineering-web-phish-class.png">
                </section>
                <section>
                    <h2>Metasploit Module Naming Convention</h2>
                    <ul>
                        <li><code>Metasploit<em>N</em></code>

                            <ul>
                                <li><code><em>N</em></code> is <emphasis>minimum</emphasis> major version of Metasploit Framework</li>
                            </ul>
                        </li>
                        <li>1821 <code>Metasploit3</code> classes or modules</li>
                        <li>32 <code>Metasploit4</code> classes or modules</li>
                    </ul>
                    <aside class="notes">
                        This convention isn't well used.  Most developers just copy the N from the example they are using.
                    </aside>
                </section>
            </section>
            <section class="stack">
                <section>
                    <h1>Tracking anonymous Module creation</h1>
                </section>
                <section>
                    <h2><code>Module.new</code> Usages</h2>
                    <img class="stretch" src="images/module-new-in-metasploit-framework-lib.png">
                </section>
                <section>
                    <h2>
                        <code>Msf::ModuleManager#reload_module</code>
                    </h2>
                    <img class="stretch" src="images/module-new-in-msf-module-manager-reload-module.png">
                </section>
                <section>
                    <h2>
                        <code>Msf::ModuleManager#load_module_from_file</code>
                    </h2>
                    <img class="stretch" src="images/module-new-in-msf-module-manager-load-module-from-file.png">
                </section>
                <section>
                    <h2>
                        <code>Msf::ModuleManager#load_module_from_archive</code>
                    </h2>
                    <img class="stretch" src="images/module-new-in-msf-module-manager-load-module-from-archive.png">
                </section>
            </section>
            <section>
                <h1>De-anonymizing namespace Modules</h1>
            </section>
            <section class="stack">
                <section>
                    <h2>Replace <code>Module.new</code></h2>
                    <ol>
                        <li>The name must be unique to prevent naming collisions</li>
                        <li>The name must be deterministic to allow replacement on reload</li>
                    </ol>
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-wrapper-module.png">
                </section>
                <section>
                    <ul>
                        <li>
                            <code>name</code> is
                            <code>/</code> separated (
                            <code>auxiliary/pro/social_engineering/web_phish</code>)
                        </li>
                        <li>
                            <code>String#camelize</code> will convert
                            <code>/</code> separated to
                            <code>Module#name</code>
                        </li>
                    </ul>
                    <br/>
                    <img src="images/msf-module-manager-wrapper-module-name.png">
                    <pre><code>
&gt;&gt; "auxiliary/pro/social/engineering/web_phish".camelize
=&gt; "Auxiliary::Pro::SocialEngineering::WebPhish"
                    </code></pre>
                </section>
                <section>
                    <h1>Why start with <code>Object</code>?</h1>
                    <ul>
                        <li>Object is root of constant names</li>
                        <li>Derived from ModuleConstMissing#const_missing</li>
                    </ul>
                    <br/>
                    <img class="stretch" src="images/module-const-missing-const-missing-object.png">
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-wrapper-module-until.png">
                </section>
                <section>
                    <h2>Complications</h2>
                    <ul>
                        <li>Some directories aren't valid constant names</li>
                    </ul>
                    <br/>
                    <img class="stretch" src="images/msf-module-manager-wrapper-module-hex-encoding.png">
                    <p>Hex-escaping</p>
                    <ul>
                        <li>Reversibility preserves uniqueness</li>
                        <li>Prefix with 'X' to prevent decimal digits at start of escaped name</li>
                    </ul>
                </section>
                <section>
                    <h2>Reloading</h2>
                    <img class="stretch" src="images/msf-module-manager-wrapper-module-leaf-removal.png">
                </section>
                <section>
                    <h2>Walking Down the Tree</h2>
                    <img class="stretch" src="images/msf-module-manager-wrapper-module-walk.png">
                </section>
                <section>
                    <h2>Partial existence</h2>
                    <img class="stretch" src="images/msf-module-manager-wrapper-module-child-defined.png">
                </section>
                <section>
                    <h2>Anonymous?! Module Creation</h2>
                    <img src="images/msf-module-manager-wrapper-module-module-new.png">
                    <br/>
                    <ul>
                        <li><code>child_name</code> not passed to <code>Module.new</code></li>
                    </ul>
                    <br/>
                    <img src="images/msf-module-manager-wrapper-module-const-set.png">
                    <br/>
                    <ul>
                        <li>Module#name is set on first const_set</li>
                        <li>Module#name cannot be reset</li>
                    </ul>
                </section>
            </section>
            <section>
                <table>
                    <caption><code>Module.new</code> anonymity</caption>
                    <tbody>
                    <tr>
                        <td>Msf::ModuleManager#load_module_from_file</td>
                        <td>Named</td>
                    </tr>
                    <tr>
                        <td>Msf::ModuleManager#load_module_from_archive</td>
                        <td>Anonymous</td>
                    </tr>
                    <tr>
                        <td>Msf::ModuleManager#reload_module</td>
                        <td>Anonymous</td>
                    </tr>
                    </tbody>
                </table>
            </section>
            <section>
                <h1>Refactoring to ease understanding</h1>
                <h2>Don't just read the code</h2>
            </section>
            <section class="stack">
                <section>
                    <h2>One Class/Module per file</h2>
                    <ul>
                        <li>Make code easier to find</li>
                        <li>Follows Rails convention for loading</li>
                    </ul>
                </section>
                <section>
                    <img class="stretch" src="images/module-manager-structure.png">
                </section>
            </section>
            <section class="stack">
                <section>
                    <h2>Group related method into included Modules</h2>
                    <ul>
                        <li>Intermediate step before extracting Classes</li>
                        <li>Moves ensure no method calling changes required</li>
                        <li>Less thorough testing required than extract Class</li>
                    </ul>
                </section>
                <section>
                    <img src="images/msf-module-manager-structure.png" style="float: left; max-width: 50%">
                    <div style="float: right; max-width: 50%">
                        <h1>Categories</h1>
                        <ul>
                            <li>cache (
                                <code>#cache_entires</code>,
                                <code>#rebuild_cache</code>,
                                <code>#refresh_cache</code>)
                            </li>
                            <li>creating
                                <code>Msf::Module</code> instances (
                                <code>#create</code>)
                            </li>
                            <li>loading (
                                <code>#demand_load_module</code>,
                                <code>#failed</code>,
                                <code>#has_archive_file_changed?</code>,
                                <code>#has_module_file_changed?</code>,
                                <code>#load_module_from_archive</code>,
                                <code>#load_module_from_file</code>,
                                <code>#load_module_source</code>,
                                <code>#load_modules</code>,
                                <code>#load_modules_from_archive</code>,
                                <code>#load_modules_from_directory</code>,
                                <code>#on_module_load</code>)
                            </li>
                            <li>module sets (
                                <code>#auxiliary</code>,
                                <code>#encoders</code>,
                                <code>#exploits</code>,
                                <code>#init_module_set</code>,
                                <code>#module_names</code>,
                                <code>#module_set</code>,
                                <code>#module_types</code>,
                                <code>#nops</code>,
                                <code>#payloads</code>,
                                <code>#post</code>)
                            </li>
                            <li>module paths (
                                <code>#add_module_path</code>,
                                <code>#remove_module_path</code>)
                            </li>
                            <li>reloading (
                                <code>#reload_module</code>,
                                <code>#reload_modules</code>)
                            </li>
                            <li>unknown (
                                <code>#add_module</code>,
                                <code>#auto_subscribe_module</code>,
                                <code>#register_type_extension</code>)
                            </li>
                        </ul>
                    </div>
                </section>
                <section>
                    <h2>Unknowns</h2>
                    <ul>
                        <li><code>#add_module</code></li>
                        <li><code>#auto_subscribe_module</code></li>
                        <li><code>#register_type_extension</code></li>
                    </ul>
                </section>
                <section>
                    <h2>
                        <code>Msf::ModuleManager#add_module</code>
                    </h2>
                    <img class="stretch" src="images/msf-module-manager-add-module.png">
                    <br/>
                    <ul>
                        <li>Calls <code>#auto_subscribe_module</code></li>
                        <li>Calls <code>framework.events.on_module_load</code></li>
                    </ul>
                    <p>Probably loading related...</p>
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-add-module-find-usages.png">
                    <p>Called from <code>#on_module_load</code>, so definitely loading</p>
                </section>
                <section>
                    <h2>
                        <code>Msf::ModuleManager#register_type_extension</code>
                    </h2>
                    <img class="stretch" src="images/msf-module-manager-register-type-extension.png">
                    <p>Dead Code?</p>
                </section>
                <section>
                    <h2>Only occurrence is <code>def</code> = dead</h2>
                    <img src="images/find-register-type-extension.png">
                </section>
                <section>
                    <h2>Extract Modules</h2>
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-module-paths.png">
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-cache.png">
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-module-sets.png">
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-reloading.png">
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-loading.png">
                </section>
            </section>
            <section class="stack">
                <section>
                    <h2>Breaking up into Classes</h2>
                    <ul>
                        <li>Common methods for base class</li>
                        <li>2 or more set of methods that follow pattern for subclasses</li>
                    </ul>
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-loading-structure.png">
                    <ul>
                        <li>Too long (466 lines)</li>
                        <li>Too many methods (13)</li>
                    </ul>
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-loading-structure.png" style="float: left; max-width: 50%">
                    <div style="float: right; max-width: 50%">
                        <h1>Horizontal integration</h1>
                        <ul>
                            <li>file_changed? (
                                <code>#has_archive_file_changed?</code>,
                                <code>#has_module_file_changed?</code>)
                            </li>
                            <li>load_module (
                                <code>#add_module</code>,
                                <code>#auto_subscribe_module</code>,
                                <code>#demand_load_module</code>,
                                <code>#failed</code>,
                                <code>#load_module_from_archive</code>,
                                <code>#load_module_from_file</code>,
                                <code>#load_module_source</code>,
                                <code>#on_module_load</code>)
                            </li>
                            <li>load_modules (
                                <code>#load_modules</code>,
                                <code>#load_modules_from_archive</code>,
                                <code>#load_modules_from_directory</code>)
                            </li>
                        </ul>
                    </div>
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-loading-structure.png" style="float: left; max-width: 50%">
                    <div style="float: right; max-width: 50%">
                        <h1>Vertical integration</h1>
                        <ul>
                            <li>archive (
                                <code>#has_archive_file_changed?</code>,
                                <code>#load_module_from_archive</code>,
                                <code>#load_modules_from_archive</code>)
                            </li>
                            <li>common (
                                <code>#add_module</code>,
                                <code>#auto_subscribe_module</code>,
                                <code>#demand_load_module</code>,
                                <code>#failed</code>,
                                <code>#load_modules</code>,
                                <code>#on_module_load</code>)
                            </li>
                            <li>directory (
                                <code>#has_module_file_changed?</code>,
                                <code>#load_module_from_file</code>,
                                <code>#load_module_source</code>,
                                <code>#load_modules_from_directory</code>)
                            </li>
                        </ul>
                    </div>
                </section>
                <section>
                    <table>
                        <tbody>
                        <tr>
                            <th colspan="2" rowspan="2"></th>
                            <th colspan="2">Category</th>
                        </tr>
                        <tr>
                            <th>archive</th>
                            <th>directory</th>
                        </tr>
                        <tr>
                            <th rowspan="4">Method</th>
                            <th><code>#file_changed?</code></th>
                            <td><code>#has_archive_file_changed?</code></td>
                            <td><code>#has_module_file_changed?</code></td>
                        </tr>
                        <tr>
                            <th><code>#load_module</code></th>
                            <td><code>#load_module_from_archive</code></td>
                            <td><code>#load_module_from_file</code></td>
                        </tr>
                        <tr>
                            <th><code>#load_source</code></th>
                            <td><code>Fastlib.load</code></td>
                            <td><code>#load_module_source</code></td>
                        </tr>
                        <tr>
                            <th><code>#load_modules</code></th>
                            <td><code>#load_modules_from_archive</code></td>
                            <td><code>#load_modules_from_directory</code></td>
                        </tr>
                        </tbody>
                    </table>
                </section>
            </section>
            <section class="stack">
                <section>
                    <h2>Separating extracted&nbsp;class from source class</h2>
                    <ol>
                        <li>Read each method</li>
                        <li>If override of source class, keep in source class</li>
                        <li>Use Find Usages</li>
                        <li>If public interface of source class, keep in source class</li>
                        <li>If overridden in extracted class subclasses, move to extracted class</li>
                        <li>If helper for extracted class subclasses, move to extracted class</li>
                    </ol>
                </section>
                <section>
                    <img class="stretch" src="images/msf-module-manager-add-module.png">
                </section>
            </section>
        </div>
    </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom
        width: 1920,
        height: 1200,
        slideNumber: true,

        // Optional reveal.js plugins
        dependencies: [
            {
                src: 'lib/js/classList.js', condition: function () {
                return !document.body.classList;
            }
            },
            {
                src: 'plugin/markdown/marked.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/markdown/markdown.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/highlight/highlight.js', async: true, condition: function () {
                return !!document.querySelector('pre code');
            }, callback: function () {
                hljs.initHighlightingOnLoad();
            }
            },
            {src: 'plugin/zoom-js/zoom.js', async: true},
            {src: 'plugin/notes/notes.js', async: true}
        ]
    });

</script>

</body>
</html>
